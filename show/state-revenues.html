<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>USEITI Data: State Revenues</title>
    <script src="../js/vendor/d3.v3.min.js"></script>
    <script src="../js/vendor/queue.v1.min.js"></script>
    <script src="../js/vendor/topojson.v1.min.js"></script>
    <script src="../js/vendor/colorbrewer.js"></script>
    <script src="../lib/albers-custom.js"></script>
    <script src="../js/progressive.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <style type="text/css">
      h2 { margin: 0; }
    </style>
  </head>
  <body>
    <div id="progress">
      <div class="bar"><span class="label"></span></div>
    </div>

    <section id="maps">
    </section>

    <section id="chart">
    </section>

    <svg id="symbols">
    </svg>

    <script>
(function(exports) {

  var data = exports.data = {};

  var prog = progressive();

  d3.select('#progress')
    .call(progressive.bar(prog));

  console.log('loading...');
  var dataPath = '../output/';
  queue()
    .defer(prog, d3.tsv, dataPath + 'state/revenues-2013.tsv')
    .defer(prog, d3.json, dataPath + 'geo/us-states.json')
    .await(function(error, stateRevenues, topology) {
      if (error) return showError(error.responseText);

      data.revenues = {
        state: stateRevenues
      };

      console.time('topology');
      var states = topology.objects.states;
      data.geo = {
        states: {
          topology: topology,
          features: topojson.feature(topology, states).features,
          mesh: topojson.mesh(topology, states)
        }
      };
      console.timeEnd('topology');

      console.log('loaded!', data);
      loaded();
    });

  function loaded() {
    var proj = d3.geo.albersCustom();

    var path = d3.geo.path()
      .projection(proj);

    var size = proj.size ? proj.size() : [960, 500];

    var symbols = d3.select('svg#symbols');
    var defs = symbols.append('defs');
    var mesh = defs.append('path')
      .attr('id', 'states-mesh')
      .attr('class', 'mesh states')
      .attr('d', path(data.geo.states.mesh));

    var index = d3.nest()
      .key(getter('Commodity'))
      .key(getter('State'))
      .rollup(function(d) {
        return d3.sum(d, getter('Revenue'));
      })
      .map(data.revenues.state);

    var commodities = d3.entries(index);
    var scales = d3.scale.ordinal()
      .range(Object.keys(colorbrewer));

    commodities.forEach(function(c) {
      c.max = d3.max(d3.values(c.value));
      console.log(c.key, 'extent:', c.extent);
      var scaleKey = scales(c.key);
      c.scale = d3.scale.quantize()
        .domain([0, c.max])
        .range(colorbrewer[scaleKey][9]);
    });

    console.log('commodities:', commodities);

    var div = d3.select('#maps')
      .selectAll('section.commodity')
      .data(commodities)
      .enter()
      .append('section')
        .attr('class', 'commodity')
        .attr('id', function(d) { return d.key; });

    div.append('h2')
      .text(function(d) { return d.key; });

    var svg = div.append('svg')
      .attr('class', 'map')
      .attr('viewBox', [0, 0].concat(size).join(' '));

    var g = svg.append('g')
      .attr('class', 'features states');

    var states = data.geo.states.features;

    var feature = g.selectAll('path.state')
      .data(function(d) {
        var commodity = d.key;
        return states.map(function(feature) {
          var state = feature.properties.abbr;
          return {
            state: state,
            feature: feature,
            commodity: d,
            value: d.value[state] || 0
          };
        });
      })
      .enter()
      .append('path')
        .attr('class', 'state')
        .attr('id', function(d) {
          return 'state-feature-' + d.state;
        })
        .attr('d', function(d) {
          return path(d.feature);
        })
        .attr('fill', function(d) {
          return d.commodity.scale(d.value);
        });

    feature.append('title')
      .text(function(d) { return d.state; });

    svg.append('use')
      .attr('xlink:href', '#states-mesh');
  }

  function getter(key) {
    return function(d) {
      return d[key];
    };
  }

  function showError(error) {
    alert('Error: ' + error);
  }

})(this);
    </script>
  </body>
</html>
