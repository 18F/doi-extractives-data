<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>USEITI Data: Revenue Types</title>
    <script src="../js/vendor/d3.v3.min.js"></script>
    <script src="../js/vendor/queue.v1.min.js"></script>
    <script src="../js/vendor/topojson.v1.min.js"></script>
    <script src="../js/vendor/d3-tip.min.js"></script>
    <script src="../js/progressive.js"></script>
    <script src="../js/eiti.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <style type="text/css">
      h2 { margin: 0; }

      path.line {
        fill: none;
        stroke-width: 2;
      }

      path.avg {
        fill: none;
        stroke-dasharray: 1 2;
      }

      circle.point {
        stroke: white;
        stroke-width: 1;
      }

      .tooltip {
        background: white;
        opacity: .8;
        border: 1px solid #ccc;
        padding: .2em .5em .3em;
      }

    </style>
  </head>
  <body>
    <div id="progress">
      <div class="bar"><span class="label"></span></div>
    </div>

    <section id="national">
    </section>

    <script>
(function(exports) {

  var data = exports.data = {};

  var prog = progressive();

  var getter = eiti.data.getter;

  d3.select('#progress')
    .call(progressive.bar(prog));

  console.log('loading...');
  var dataPath = '../output/';
  queue()
    .defer(prog, d3.tsv, dataPath + 'national/revenues-yearly.tsv')
    .await(function(error, natlRevenues) {
      if (error) return showError(error.responseText);

      data.revenues = {
        national: natlRevenues,
      };

      console.log('loaded!', data);
      loaded();
    });

  function loaded() {
    var chart = d3.select('#national')
      .selectAll('.chart')
      .data([
        {title: "Line Chart", avg: true}
      ])
      .enter()
      .append('div')
        .attr('class', 'chart');

    chart.append('h2')
      .attr('class', 'chart-title')
      .text(function(d) { return d.title; });

    chart.append('svg')
      .attr('class', 'area')
      .each(function(d) {
        var line = lineChart()
          .x('Year')
          .y('Revenue Type')
          .average(d.avg);

        var tip = eiti.ui.tip()
          .attr('class', 'tooltip')
          .offset([-5, 0])
          .html(function(d) {
            return [
              d.key, ': ',
              eiti.format.shortDollars(d.y),
              ' in ', d.x
            ].join('');
          });

        d3.select(this)
          .call(line, data.revenues.national)
          .call(tip)
          .selectAll('circle')
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide);
      });
  }

  function lineChart() {
    var dx = getter('Year');
    var dy = getter('Commodity');
    var value = getter('Revenue');
    var average = false;

    var width = 900;
    var height = 300;

    var margin = {
      top: 10,
      bottom: 40,
      left: 120,
      right: 60
    };

    var chart = function(svg, data) {
      svg.attr('viewBox', [0, 0, width, height].join(' '));

      var index = d3.nest()
        .key(dy)
        .key(dx)
        .rollup(function(d) {
          return d3.sum(d, value);
        })
        .map(data);

      var xs = d3.extent(data, dx).map(Number);
      var ys = d3.keys(index);
      var xd = d3.range(xs[0], xs[1] + 1);
      var layers = ys.map(function(y) {
        return xd.map(function(x) {
          var z = index[y][x] || 0;
          // if (stacked && z < 0) z = 0;
          return {
            x: x,
            y: z,
            key: y
          };
        });
      });

      layers.forEach(function(d) {
        d.key = d[0].key;
        d.sum = d3.sum(d, getter('y'));
      });

      layers.sort(function(a, b) {
        return d3.descending(a.sum, b.sum);
      });

      var yv = [];
      layers.forEach(function(d) {
        yv = yv.concat(d.map(function(x) { return x.y; }));
      });
      var yd = d3.extent(yv);
      var y0 = height - margin.bottom;
      var y1 = margin.top;

      var y = d3.scale.linear()
        .domain(yd)
        .range([y0, y1])
        .nice();

      var x = d3.scale.linear()
        .domain(d3.extent(data, dx))
        .range([margin.left, width - margin.right]);

      var yAxis = d3.svg.axis()
        .orient('right')
        .scale(y);

      var si = d3.format('s');
      var suffix = {K: 'k', M: 'm', G: 'b'};
      var ticks = 12;
      var yFormat = function(n, i) {
        return si(n).replace(/[KMG]$/, function(s) {
          return suffix[s] || s;
        });
      };

      yAxis
        .ticks(ticks)
        .tickFormat(yFormat);

      var offset = 0;
      svg.append('g')
        .attr('class', 'axis y')
        .attr('transform', 'translate(' + [width - margin.right + 2, offset] + ')')
        .call(yAxis);

      svg.append('g')
        .attr('class', 'axis x')
        .attr('transform', 'translate(' + [0, height - margin.bottom + offset] + ')')
        .call(d3.svg.axis()
          .orient('bottom')
          .scale(x)
          .tickFormat(d3.format('d')));

      var color = d3.scale.category20();

      var line = d3.svg.line()
        .interpolate('linear')
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); });

      if (average) {
        var ga = svg.append('g')
          .attr('class', 'averages');

        ga.selectAll('path.avg')
          .data(layers)
          .enter()
          .append('path')
            .attr('class', 'avg')
            .attr('stroke', function(d) {
              return color(d.key);
            })
            .attr('d', function(d) {
              var avg = d3.mean(d, getter('y'));
              return line([
                {x: xd[0], y: avg},
                {x: xd[xd.length - 1], y: avg}
              ]);
            });
      }

      var g = svg.selectAll('g.layer')
        .data(layers)
        .enter()
        .append('g')
          .attr('class', 'layer');

      var paths = g.append('path')
        .attr('class', 'line')
        .attr('stroke', function(d) {
          return color(d.key);
        })
        .attr('d', line);

      var points = g.selectAll('circle.point')
        .data(function(d) { return d; })
        .enter()
        .append('circle')
          .attr('class', 'point')
          .attr('r', 3)
          .attr('fill', function(d) { return color(d.key); })
          .attr('cx', function(d) { return x(d.x); })
          .attr('cy', function(d) { return y(d.y); })

      var size = 10;
      var spacing = 4;
      var legend = svg.append('g')
        .attr('class', 'legend');

      var item = legend.selectAll('.item')
        .data(layers)
        .enter()
        .append('g')
          .attr('class', 'item')
          .attr('transform', function(d, i) {
            return 'translate(' + [0, spacing + i * (size + spacing)] + ')';
          });

      item.append('rect')
        .attr('class', 'swatch')
        .attr({
          x: spacing,
          width: size,
          height: size,
        })
        .attr('fill', function(d) {
          return color(d.key);
        });

      item.append('text')
        .attr('class', 'label')
        .attr('font-size', size)
        .attr('dx', size + spacing * 2)
        .attr('dy', size * .9)
        .text(function(d) { return d.key; });

      function hilite(other) {
        return function(selection) {
          selection.on('mouseover', function(d) {
            this.classList.add('hilite');
            other && other.classed('hilite', function(o) {
              return o === d;
            });
          })
          .on('mouseout', function(d) {
            this.classList.remove('hilite');
            other && other.classed('hilite', false);
          });
        };
      }

      g.call(hilite(item));
      item.call(hilite(g));

      var bbox = legend.node().getBBox();
      var bg = legend.insert('rect', '.item')
        .attr('class', 'bg')
        .attr('fill', '#fff')
        .attr('width', ~~bbox.width + spacing * 2)
        .attr('height', ~~bbox.height + spacing * 2);
    };

    chart.x = function(_) {
      if (!arguments.length) return dx;
      dx = (typeof _ === 'string')
        ? getter(_)
        : d3.functor(_);
      return chart;
    };

    chart.y = function(_) {
      if (!arguments.length) return dy;
      dy = (typeof _ === 'string')
        ? getter(_)
        : d3.functor(_);
      return chart;
    };

    chart.average = function(_) {
      if (!arguments.length) return average;
      average = !!_;
      return chart;
    };

    return chart;
  }

  function showError(error) {
    alert('Error: ' + error);
  }

})(this);
    </script>
  </body>
</html>
