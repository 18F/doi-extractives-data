<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>USEITI Data: Hierarchy</title>
    <script src="../js/vendor/d3.v3.min.js"></script>
    <script src="../js/vendor/queue.v1.min.js"></script>
    <script src="../js/vendor/colorbrewer.js"></script>
    <script src="../js/eiti.js"></script>
    <script src="../js/progressive.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <style>

      h2 {
        margin: .5em 0;
      }

      .tree {
        position: relative;
        box-sizing: border-box;
      }

      .tree .node rect {
        fill-opacity: .6;
        stroke: #fff;
        stroke-width: 1;
        shape-rendering: crispEdges;
      }

      .tree .node .label {
        font-size: 12px;
      }

    </style>
  </head>
  <body>
    <div id="progress">
      <div class="bar"><span class="label"></span></div>
    </div>

    <h1>Revenue Hierarchies</h1>
    <section id="hierarchy">
    </section>
  </body>
  <script>
(function(exports) {

  var data = exports.data = {};

  var prog = progressive();

  var commodities = new eiti.data.Commodities();

  var setCommodity = function(d) {
    d.ActualCommodity = d.Commodity;
    d.Commodity = commodities.getGroup(d.Commodity);
  };

  var getter = eiti.data.getter;

  var sum = function(list, key) {
    if (typeof key === 'string') key = getter(key);
    return d3.sum(list, key);
  };

  d3.select('#progress')
    .call(progressive.bar(prog));

  var color = d3.scale.category20c();

  var nextId = (function() {
    var id = 1;
    return function(prefix) {
      return (prefix || 'node') + (id++);
    };
  })();

  console.log('loading...');
  console.time('load');
  var dataPath = '../output/';
  queue()
    .defer(prog, d3.tsv, dataPath + 'national/revenues-yearly.tsv')
    .defer(prog, d3.tsv, dataPath + 'state/revenues-yearly.tsv')
    .defer(prog, d3.tsv, dataPath + 'offshore/revenues-yearly.tsv')
    .await(function(error, natlRevenues, stateRevenues, offshoreRevenues) {
      console.timeEnd('load');
      if (error) return console.error(error.responseText);

      natlRevenues.forEach(setCommodity);
      stateRevenues.forEach(setCommodity);
      offshoreRevenues.forEach(setCommodity);

      stateRevenues.forEach(function(d) {
        d.Shore = 'Onshore';
        d.Region = 'States';
        d.Area = d.State;
      });

      offshoreRevenues.forEach(function(d) {
        d.Shore = 'Offshore';
      });

      data.sums = {
        national: sum(natlRevenues, 'Revenue'),
        state: sum(stateRevenues, 'Revenue'),
        offshore: sum(offshoreRevenues, 'Revenue')
      };

      data.revenues = {
        national: natlRevenues,
        state: stateRevenues,
        offshore: offshoreRevenues
      };

      var nodes = [];
      nodes = nodes.concat(stateRevenues);
      nodes = nodes.concat(offshoreRevenues);

      data.nodes = nodes;

      console.log('loaded!', data);
      loaded();
      eiti.util.jiggleHash();
    });

  function loaded() {

    var sortByName = function(a, b) {
      return d3.ascending(a.name, b.name);
    };

    var configs = [
      {
        keys: ['Type', 'Commodity'],
        totals: true
      },
      {
        keys: ['Type', 'Region', 'Commodity']
      },
      {
        keys: ['Commodity', 'Region', 'Area']
      },
      {
        keys: ['Region', 'Area', 'Commodity']
      },
      {
        keys: ['Shore', 'Area', 'Commodity']
      },
      {
        keys: ['Year', 'Commodity', 'Area'],
        sort: sortByName
      },
      {
        keys: ['Area', 'Year'],
        sort: sortByName
      },
      {
        keys: ['Commodity', 'ActualCommodity'],
        totals: true
      },
      {
        keys: ['Shore', 'Year', 'Commodity'],
        sort: sortByName
      },
    ];

    var section = d3.select('#hierarchy')
      .selectAll('section')
      .data(configs)
      .enter()
      .append('section')
        .attr('id', function(d) {
          return d.id = d.keys
            .map(clean)
            .join('_');
        });

    section.append('h2')
      .append('a')
        .attr('href', function(d) {
          return '#' + d.id;
        })
        .text(function(d) {
          return d.keys.map(unCamelCase).join(' / ');
        });

    section.each(function(d) {
      var render = renderTree()
        .keys(d.keys)
        .totals(d.totals);
      if (d.sort) {
        render.sort(d.sort);
      }
      d3.select(this).call(render);
    });
  }

  function renderTree() {
    var keys = [];
    var sort = function(a, b) {
      return d3.descending(a.value, b.value);
    };

    var totals = false;

    var render = function(selection) {
      var name = getter(keys[keys.length - 1]);
      data.nodes.forEach(function(d, i) {
        d.index = i;
        d.name = name(d);
      });

      var tree = treeify(data.nodes, keys, 'Revenue');
      // console.log('tree:', tree);

      var width = 900;
      var height = 700;

      var treemap = d3.layout.partition()
        .size([height, width])
        .sort(sort);
        // .padding([10, 2, 2, 2])
        // .round(true);

      var root = selection
        .append('svg')
          .attr('class', 'tree')
          .style('width', width + 'px')
          .style('height', height + 'px');

      var offx = -width / (keys.length + 1);
      var w = width / keys.length;

      var g = root
        .datum(tree)
        .selectAll('.node')
          .data(treemap.nodes)
          .enter()
          .append('g')
            .each(function(d) {
              var y = d.x;
              d.x = totals ? d.y : (d.depth - 1) * w;
              d.y = y;
              y = d.dx;
              d.dx = totals ? d.dy : w;
              d.dy = y;
            })
            .attr('class', 'node')
            .attr('transform', function(d) {
              return 'translate(' + [d.x, d.y] + ')';
            });

      g.append('rect')
        .attr('id', function(d) {
          return d.id = nextId('rect');
        })
        .attr('width', function(d) {
          return Math.max(0, d.dx);
        })
        .attr('height', function(d) {
          return Math.max(0, d.dy);
        })
        .attr('fill', function(d) {
          if (d.name === 'All') return '#eee';
          return color(d.name);
        });

      var title = function(d) {
        return [
          d.children ? d.name : d.node.name,
          ': ',
          eiti.format.shortDollars(d.value)
        ].join('');
      };

      g.append('title')
        .text(title);

      g.filter(function(d) {
          return d.dy > 20;
        })
        .append('text')
          .attr('class', 'label')
          .attr('dy', '1.4em')
          .attr('dx', '.6em')
          .text(title);
    };

    render.keys = function(_) {
      if (!arguments.length) return keys;
      keys = _;
      return render;
    };

    render.sort = function(_) {
      if (!arguments.length) return keys;
      sort = _;
      return render;
    };

    render.totals = function(_) {
      if (!arguments.length) return totals;
      totals = !!_;
      return render;
    };

    return render;
  }

  function treeify(nodes, groupKeys, sumKey) {
    var nest = d3.nest();
    groupKeys
      .map(getter)
      .forEach(nest.key);
    var name = getter(groupKeys[groupKeys.length - 1]);
    nest.rollup(function(d, i) {
      return {
        node: d[0],
        name: name(d[0]),
        value: sum(d, sumKey)
      };
    });

    function expand(node, name, leaf, depth) {
      if (leaf(node)) return node;
      if (!depth) depth = 0;
      return {
        name: name,
        depth: depth,
        keys: groupKeys.slice(0, depth),
        children: Object.keys(node)
          .map(function(key) {
            return expand(node[key], key, leaf, depth + 1);
          })
      };
    }

    return expand(nest.map(nodes), 'All', function(d) {
      return d.value;
    });
  }

  function clean(str) {
    return String(str)
      .toLowerCase()
      .replace(/\s+/g, '');
  }

  function unCamelCase(str) {
    return str.replace(/([a-z])([A-Z])/g, function(_, a, b) {
      return [a, b].join(' ');
    });
  }

})(this);
  </script>
</html>
